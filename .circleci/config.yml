steps:
  - run:
      name: Confirm that environment variables are set
      command: |
        if [ -z "$AWS_ACCESS_KEY_ID" ]; then
          echo "No AWS_ACCESS_KEY_ID is set. Skipping build-and-push job ..."
          circleci-agent step halt
        fi
  - aws-cli/setup:
      profile-name: <<parameters.profile-name>>
      aws-access-key-id: <<parameters.aws-access-key-id>>
      aws-secret-access-key: <<parameters.aws-secret-access-key>>
      aws-region: <<parameters.region>>

  - run:
      name: Log into Amazon ECR
      command: |
        aws ecr-public get-login-password --region $<<parameters.region>> --profile <<parameters.profile-name>> | docker login --username AWS --password-stdin $<<parameters.account-url>>
  - checkout

  - setup_remote_docker:
      version: 19.03.13
      docker_layer_caching: false

  - run:
      name: Build docker image
      command: |
        registry_id=$(echo $<<parameters.account-url>> | sed "s;\..*;;g")
        docker_tag_args=""
        IFS="," read -ra DOCKER_TAGS \<<< "<< parameters.tag >>"
        for tag in "${DOCKER_TAGS[@]}"; do
          docker_tag_args="$docker_tag_args -t $<<parameters.account-url>>/<<parameters.repo>>:$tag"
        done
        docker build \
          <<#parameters.extra-build-args>><<parameters.extra-build-args>><</parameters.extra-build-args>> \
          --target <<parameters.target>> \
          -f <<parameters.path>>/<<parameters.dockerfile>> \
          $docker_tag_args \
          <<parameters.path>>
  - run:
      name: Push image to Amazon ECR
      command: |
        IFS="," read -ra DOCKER_TAGS \<<< "<< parameters.tag >>"
        for tag in "${DOCKER_TAGS[@]}"; do
          docker push $<<parameters.account-url>>/<<parameters.repo>>:${tag}
        done
publish-packer-snap:
  description: build packer image with snap. mainnet only.
  executor:
    name: packer
  steps:
    - checkout
    - attach_workspace:
        at: "."
    - packer_build:
        template: tools/packer/lotus-snap.pkr.hcl
publish-dockerhub:
  description: publish to dockerhub
  machine:
    image: ubuntu-2004:202010-01
  parameters:
    tag:
      type: string
      default: latest
  steps:
    - checkout
    - run:
        name: dockerhub login
        command: echo $DOCKERHUB_PASSWORD | docker login --username $DOCKERHUB_USERNAME --password-stdin
    - run:
        name: docker build
        command: |
          docker build --target lotus -t filecoin/lotus:<< parameters.tag >> -f Dockerfile.lotus .
          docker build --target lotus-all-in-one -t filecoin/lotus-all-in-one:<< parameters.tag >> -f Dockerfile.lotus .
          if [[ ! -z $CIRCLE_SHA1 ]]; then
            docker build --target lotus -t filecoin/lotus:$CIRCLE_SHA1 -f Dockerfile.lotus .
            docker build --target lotus-all-in-one -t filecoin/lotus-all-in-one:$CIRCLE_SHA1 -f Dockerfile.lotus .
          fi
          if [[ ! -z $CIRCLE_TAG ]]; then
            docker build --target lotus -t filecoin/lotus:$CIRCLE_TAG -f Dockerfile.lotus .
            docker build --target lotus-all-in-one -t filecoin/lotus-all-in-one:$CIRCLE_TAG -f Dockerfile.lotus .
          fi
    - run:
        name: docker push
        command: |
          docker push filecoin/lotus:<< parameters.tag >>
          docker push filecoin/lotus-all-in-one:<< parameters.tag >>
          if [[ ! -z $CIRCLE_SHA1 ]]; then
            docker push filecoin/lotus:$CIRCLE_SHA1
            docker push filecoin/lotus-all-in-one:$CIRCLE_SHA1
          fi
          if [[ ! -z $CIRCLE_TAG ]]; then
            docker push filecoin/lotus:$CIRCLE_TAG
            docker push filecoin/lotus-all-in-one:$CIRCLE_TAG
          fi
workflows:
  ci:
    jobs:
      - build
      - lint-all:
          requires:
            - build
      - mod-tidy-check:
          requires:
            - build
      - gofmt:
          requires:
            - build
      - gen-check:
          requires:
            - build
      - docs-check:
          requires:
            - build
      - test:
          name: test-itest-api
          requires:
            - build
          suite: itest-api
          target: "./itests/api_test.go"
      - test:
          name: test-itest-batch_deal
          requires:
            - build
          suite: itest-batch_deal
          target: "./itests/batch_deal_test.go"
      - test:
          name: test-itest-ccupgrade
          requires:
            - build
          suite: itest-ccupgrade
          target: "./itests/ccupgrade_test.go"
      - test:
          name: test-itest-cli
          requires:
            - build
          suite: itest-cli
          target: "./itests/cli_test.go"
      - test:
          name: test-itest-deadlines
          requires:
            - build
          suite: itest-deadlines
          target: "./itests/deadlines_test.go"
      - test:
          name: test-itest-deals_512mb
          requires:
            - build
          suite: itest-deals_512mb
          target: "./itests/deals_512mb_test.go"
      - test:
          name: test-itest-deals_anycid
          requires:
            - build
          suite: itest-deals_anycid
          target: "./itests/deals_anycid_test.go"
      - test:
          name: test-itest-deals_concurrent
          requires:
            - build
          suite: itest-deals_concurrent
          target: "./itests/deals_concurrent_test.go"
          executor: golang-2xl
      - test:
          name: test-itest-deals_invalid_utf8_label
          requires:
            - build
          suite: itest-deals_invalid_utf8_label
          target: "./itests/deals_invalid_utf8_label_test.go"
      - test:
          name: test-itest-deals_max_staging_deals
          requires:
            - build
          suite: itest-deals_max_staging_deals
          target: "./itests/deals_max_staging_deals_test.go"
      - test:
          name: test-itest-deals_offline
          requires:
            - build
          suite: itest-deals_offline
          target: "./itests/deals_offline_test.go"
      - test:
          name: test-itest-deals_padding
          requires:
            - build
          suite: itest-deals_padding
          target: "./itests/deals_padding_test.go"
      - test:
          name: test-itest-deals_partial_retrieval_dm-level
          requires:
            - build
          suite: itest-deals_partial_retrieval_dm-level
          target: "./itests/deals_partial_retrieval_dm-level_test.go"
      - test:
          name: test-itest-deals_partial_retrieval
          requires:
            - build
          suite: itest-deals_partial_retrieval
          target: "./itests/deals_partial_retrieval_test.go"
      - test:
          name: test-itest-deals_power
          requires:
            - build
          suite: itest-deals_power
          target: "./itests/deals_power_test.go"
      - test:
          name: test-itest-deals_pricing
          requires:
            - build
          suite: itest-deals_pricing
          target: "./itests/deals_pricing_test.go"
      - test:
          name: test-itest-deals_publish
          requires:
            - build
          suite: itest-deals_publish
          target: "./itests/deals_publish_test.go"
      - test:
          name: test-itest-deals_remote_retrieval
          requires:
            - build
          suite: itest-deals_remote_retrieval
          target: "./itests/deals_remote_retrieval_test.go"
      - test:
          name: test-itest-deals_retry_deal_no_funds
          requires:
            - build
          suite: itest-deals_retry_deal_no_funds
          target: "./itests/deals_retry_deal_no_funds_test.go"
      - test:
          name: test-itest-deals
          requires:
            - build
          suite: itest-deals
          target: "./itests/deals_test.go"
      - test:
          name: test-itest-dup_mpool_messages
          requires:
            - build
          suite: itest-dup_mpool_messages
          target: "./itests/dup_mpool_messages_test.go"
      - test:
          name: test-itest-eth_account_abstraction
          requires:
            - build
          suite: itest-eth_account_abstraction
          target: "./itests/eth_account_abstraction_test.go"
      - test:
          name: test-itest-eth_balance
          requires:
            - build
          suite: itest-eth_balance
          target: "./itests/eth_balance_test.go"
      - test:
          name: test-itest-eth_block_hash
          requires:
            - build
          suite: itest-eth_block_hash
          target: "./itests/eth_block_hash_test.go"
      - test:
          name: test-itest-eth_deploy
          requires:
            - build
          suite: itest-eth_deploy
          target: "./itests/eth_deploy_test.go"
      - test:
          name: test-itest-eth_filter
          requires:
            - build
          suite: itest-eth_filter
          target: "./itests/eth_filter_test.go"
      - test:
          name: test-itest-eth_hash_lookup
          requires:
            - build
          suite: itest-eth_hash_lookup
          target: "./itests/eth_hash_lookup_test.go"
      - test:
          name: test-itest-eth_transactions
          requires:
            - build
          suite: itest-eth_transactions
          target: "./itests/eth_transactions_test.go"
      - test:
          name: test-itest-fevm_address
          requires:
            - build
          suite: itest-fevm_address
          target: "./itests/fevm_address_test.go"
      - test:
          name: test-itest-fevm_events
          requires:
            - build
          suite: itest-fevm_events
          target: "./itests/fevm_events_test.go"
      - test:
          name: test-itest-fevm
          requires:
            - build
          suite: itest-fevm
          target: "./itests/fevm_test.go"
      - test:
          name: test-itest-gas_estimation
          requires:
            - build
          suite: itest-gas_estimation
          target: "./itests/gas_estimation_test.go"
      - test:
          name: test-itest-gateway
          requires:
            - build
          suite: itest-gateway
          target: "./itests/gateway_test.go"
      - test:
          name: test-itest-get_messages_in_ts
          requires:
            - build
          suite: itest-get_messages_in_ts
          target: "./itests/get_messages_in_ts_test.go"
      - test:
          name: test-itest-lite_migration
          requires:
            - build
          suite: itest-lite_migration
          target: "./itests/lite_migration_test.go"
      - test:
          name: test-itest-lookup_robust_address
          requires:
            - build
          suite: itest-lookup_robust_address
          target: "./itests/lookup_robust_address_test.go"
      - test:
          name: test-itest-mempool
          requires:
            - build
          suite: itest-mempool
          target: "./itests/mempool_test.go"
      - test:
          name: test-itest-migration_nv17
          requires:
            - build
          suite: itest-migration_nv17
          target: "./itests/migration_nv17_test.go"
      - test:
          name: test-itest-migration_nv18
          requires:
            - build
          suite: itest-migration_nv18
          target: "./itests/migration_nv18_test.go"
      - test:
          name: test-itest-mir
          requires:
            - build
          suite: itest-mir
          target: "./itests/mir_test.go"
      - test:
          name: test-itest-mpool_msg_uuid
          requires:
            - build
          suite: itest-mpool_msg_uuid
          target: "./itests/mpool_msg_uuid_test.go"
      - test:
          name: test-itest-mpool_push_with_uuid
          requires:
            - build
          suite: itest-mpool_push_with_uuid
          target: "./itests/mpool_push_with_uuid_test.go"
      - test:
          name: test-itest-multisig
          requires:
            - build
          suite: itest-multisig
          target: "./itests/multisig_test.go"
      - test:
          name: test-itest-net
          requires:
            - build
          suite: itest-net
          target: "./itests/net_test.go"
      - test:
          name: test-itest-nonce
          requires:
            - build
          suite: itest-nonce
          target: "./itests/nonce_test.go"
      - test:
          name: test-itest-path_detach_redeclare
          requires:
            - build
          suite: itest-path_detach_redeclare
          target: "./itests/path_detach_redeclare_test.go"
      - test:
          name: test-itest-path_type_filters
          requires:
            - build
          suite: itest-path_type_filters
          target: "./itests/path_type_filters_test.go"
      - test:
          name: test-itest-paych_api
          requires:
            - build
          suite: itest-paych_api
          target: "./itests/paych_api_test.go"
      - test:
          name: test-itest-paych_cli
          requires:
            - build
          suite: itest-paych_cli
          target: "./itests/paych_cli_test.go"
      - test:
          name: test-itest-pending_deal_allocation
          requires:
            - build
          suite: itest-pending_deal_allocation
          target: "./itests/pending_deal_allocation_test.go"
      - test:
          name: test-itest-raft_messagesigner
          requires:
            - build
          suite: itest-raft_messagesigner
          target: "./itests/raft_messagesigner_test.go"
      - test:
          name: test-itest-remove_verifreg_datacap
          requires:
            - build
          suite: itest-remove_verifreg_datacap
          target: "./itests/remove_verifreg_datacap_test.go"
      - test:
          name: test-itest-sdr_upgrade
          requires:
            - build
          suite: itest-sdr_upgrade
          target: "./itests/sdr_upgrade_test.go"
      - test:
          name: test-itest-sector_finalize_early
          requires:
            - build
          suite: itest-sector_finalize_early
          target: "./itests/sector_finalize_early_test.go"
      - test:
          name: test-itest-sector_import_full
          requires:
            - build
          suite: itest-sector_import_full
          target: "./itests/sector_import_full_test.go"
      - test:
          name: test-itest-sector_import_simple
          requires:
            - build
          suite: itest-sector_import_simple
          target: "./itests/sector_import_simple_test.go"
      - test:
          name: test-itest-sector_make_cc_avail
          requires:
            - build
          suite: itest-sector_make_cc_avail
          target: "./itests/sector_make_cc_avail_test.go"
      - test:
          name: test-itest-sector_miner_collateral
          requires:
            - build
          suite: itest-sector_miner_collateral
          target: "./itests/sector_miner_collateral_test.go"
      - test:
          name: test-itest-sector_numassign
          requires:
            - build
          suite: itest-sector_numassign
          target: "./itests/sector_numassign_test.go"
      - test:
          name: test-itest-sector_pledge
          requires:
            - build
          suite: itest-sector_pledge
          target: "./itests/sector_pledge_test.go"
      - test:
          name: test-itest-sector_prefer_no_upgrade
          requires:
            - build
          suite: itest-sector_prefer_no_upgrade
          target: "./itests/sector_prefer_no_upgrade_test.go"
      - test:
          name: test-itest-sector_revert_available
          requires:
            - build
          suite: itest-sector_revert_available
          target: "./itests/sector_revert_available_test.go"
      - test:
          name: test-itest-sector_terminate
          requires:
            - build
          suite: itest-sector_terminate
          target: "./itests/sector_terminate_test.go"
      - test:
          name: test-itest-sector_unseal
          requires:
            - build
          suite: itest-sector_unseal
          target: "./itests/sector_unseal_test.go"
      - test:
          name: test-itest-self_sent_txn
          requires:
            - build
          suite: itest-self_sent_txn
          target: "./itests/self_sent_txn_test.go"
      - test:
          name: test-itest-splitstore
          requires:
            - build
          suite: itest-splitstore
          target: "./itests/splitstore_test.go"
      - test:
          name: test-itest-tape
          requires:
            - build
          suite: itest-tape
          target: "./itests/tape_test.go"
      - test:
          name: test-itest-verifreg
          requires:
            - build
          suite: itest-verifreg
          target: "./itests/verifreg_test.go"
      - test:
          name: test-itest-wdpost_config
          requires:
            - build
          suite: itest-wdpost_config
          target: "./itests/wdpost_config_test.go"
      - test:
          name: test-itest-wdpost_dispute
          requires:
            - build
          suite: itest-wdpost_dispute
          target: "./itests/wdpost_dispute_test.go"
      - test:
          name: test-itest-wdpost_no_miner_storage
          requires:
            - build
          suite: itest-wdpost_no_miner_storage
          target: "./itests/wdpost_no_miner_storage_test.go"
      - test:
          name: test-itest-wdpost
          requires:
            - build
          suite: itest-wdpost
          target: "./itests/wdpost_test.go"
      - test:
          name: test-itest-wdpost_worker_config
          requires:
            - build
          suite: itest-wdpost_worker_config
          target: "./itests/wdpost_worker_config_test.go"
          executor: golang-2xl
      - test:
          name: test-itest-worker
          requires:
            - build
          suite: itest-worker
          target: "./itests/worker_test.go"
          executor: golang-2xl
      - test:
          name: test-itest-worker_upgrade
          requires:
            - build
          suite: itest-worker_upgrade
          target: "./itests/worker_upgrade_test.go"
      - test:
          name: test-unit-cli
          requires:
            - build
          suite: utest-unit-cli
          target: "./cli/... ./cmd/... ./api/..."
          get-params: true
      - test:
          name: test-unit-node
          requires:
            - build
          suite: utest-unit-node
          target: "./node/..."
          
      - test:
          name: test-unit-rest
          requires:
            - build
          suite: utest-unit-rest
          target: "./api/... ./blockstore/... ./build/... ./chain/... ./cli/... ./cmd/... ./conformance/... ./extern/... ./gateway/... ./journal/... ./lib/... ./markets/... ./node/... ./paychmgr/... ./storage/... ./tools/..."
          executor: golang-2xl
      - test:
          name: test-unit-storage
          requires:
            - build
          suite: utest-unit-storage
          target: "./storage/... ./extern/..."
          
      - test:
          go-test-flags: "-run=TestMulticoreSDR"
          requires:
            - build
          suite: multicore-sdr-check
          target: "./extern/sector-storage/ffiwrapper"
          proofs-log-test: "1"
      - test-conformance:
          requires:
            - build
          suite: conformance
          codecov-upload: false
          target: "./conformance"
      - test-conformance:
          name: test-conformance-bleeding-edge
          codecov-upload: false
          suite: conformance-bleeding-edge
          target: "./conformance"
          vectors-branch: specs-actors-v7
      - trigger-testplans:
          filters:
            branches:
              only:
                - master
      - build-debug
      - build-all:
          filters:
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/
      - build-ntwk-calibration:
          filters:
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/
      - build-ntwk-butterfly:
          filters:
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/
      - build-lotus-soup
      - build-macos:
          filters:
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/
      - build-appimage:
          filters:
            branches:
              ignore:
                - /.*/
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/
      - publish:
          requires:
            - build-all
            - build-macos
            - build-appimage
          filters:
            branches:
              ignore:
                - /.*/
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/
      - build-and-push-image:
          dockerfile: Dockerfile.lotus
          path: .
          repo: lotus-dev
          tag: '${CIRCLE_SHA1:0:8}'
          target: lotus-all-in-one
      - build-and-push-image:
          dockerfile: Dockerfile.lotus
          path: .
          repo: lotus-test
          tag: '${CIRCLE_SHA1:0:8}'
          target: lotus-test
      - publish-snapcraft:
          name: publish-snapcraft-stable
          channel: stable
          filters:
            branches:
              ignore:
                - /.*/
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/
      - publish-dockerhub:
          name: publish-dockerhub
          tag: stable
          filters:
            branches:
              ignore:
                - /.*/
            tags:
              only:
                - /^v\d+\.\d+\.\d+(-rc\d+)?$/

  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - publish-snapcraft:
          name: publish-snapcraft-nightly
          channel: edge
      - publish-dockerhub:
          name: publish-dockerhub-nightly
          tag: nightly
  monthly:
    triggers:
      - schedule:
          cron: "0 0 1 * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - publish-packer-snap
